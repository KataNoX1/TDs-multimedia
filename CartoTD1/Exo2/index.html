<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Exercice 2 - Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 70vh; }
    .panel { padding: 0.75rem 1rem; font-family: system-ui, sans-serif; }
    .row { margin: 0.25rem 0; }
    code { background: #f3f3f3; padding: 0.1rem 0.3rem; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="row"><strong>Votre position</strong> (live par <code>watchPosition</code>)</div>
    <div class="row">lat: <span id="lat">-</span>,
      lon: <span id="lon">-</span>,
      alt: <span id="alt">n/a</span>,
      speed: <span id="spd">n/a</span>,
      accuracy: <span id="acc">-</span> m</div>
    <div class="row">timestamp: <span id="ts">-</span></div>
    <div class="row"><strong>Distance Marseille -> vous</strong>: <span id="dist">-</span> km</div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    const NICE = { lat: 43.7000, lon: 7.2667 };
    const MARSEILLE = { lat: 43.2965, lon: 5.3698 };

    const BERMUDAS = [
      [25.7617, -80.1918],
      [32.3078, -64.7505],
      [18.4655, -66.1057]
    ];

    const ui = {
      lat: document.getElementById("lat"),
      lon: document.getElementById("lon"),
      alt: document.getElementById("alt"),
      spd: document.getElementById("spd"),
      acc: document.getElementById("acc"),
      ts:  document.getElementById("ts"),
      dist: document.getElementById("dist")
    };

    function fmt(n, d = 5) { return (n === null || n === undefined) ? "n/a" : Number(n).toFixed(d); }
    function km(m) { return (m / 1000).toFixed(3); }

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    });

    const stamenToner = L.tileLayer("https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}.png?api_key=eed6a6b4-d171-43e4-8215-e5f8490b4245", {
      maxZoom: 20,
      attribution: "Map tiles by Stamen Design, under CC BY 4.0. Data by OpenStreetMap, under ODbL."
    });

    const stamenTerrain = L.tileLayer("https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}.png?api_key=eed6a6b4-d171-43e4-8215-e5f8490b4245", {
      maxZoom: 20,
      attribution: "Map tiles by Stamen Design, under CC BY 4.0. Data by OpenStreetMap, under ODbL."
    });

    const stamenWatercolor = L.tileLayer("https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.png?api_key=eed6a6b4-d171-43e4-8215-e5f8490b4245", {
      maxZoom: 20,
      attribution: "Map tiles by Stamen Design, under CC BY 4.0. Data by OpenStreetMap, under ODbL."
    });

    // carte
    const map = L.map("map", {
      center: [NICE.lat, NICE.lon],
      zoom: 12,
      layers: [osm]
    });


    const baseLayers = {
        "OpenStreetMap": osm,
        "Stamen Toner": stamenToner,
        "Stamen Terrain": stamenTerrain,
        "Stamen Watercolor": stamenWatercolor
    };
    L.control.layers(baseLayers, null, { position: "topright", collapsed: true }).addTo(map);



    const niceMarker = L.marker([NICE.lat, NICE.lon]).addTo(map).bindPopup("Nice (centre)");

    const mnLine = L.polyline([[MARSEILLE.lat, MARSEILLE.lon], [NICE.lat, NICE.lon]], { color: "blue" }).addTo(map)
      .bindPopup("Segment Marseille - Nice");

    const bermPolygon = L.polygon([BERMUDAS[0], BERMUDAS[1], BERMUDAS[2]], { color: "red", weight: 2, fillOpacity: 0.05 })
      .addTo(map)
      .bindPopup("Triangle des Bermudes");

    const youMarker = L.marker([NICE.lat, NICE.lon], { draggable: false });
    const accCircle = L.circle([NICE.lat, NICE.lon], { radius: 1, color: "green", fillOpacity: 0.1 });
    const youGroup = L.layerGroup([youMarker, accCircle]).addTo(map);

    let firstFix = true;

    function updateUI(pos) {
      const c = pos.coords;
      ui.lat.textContent = fmt(c.latitude, 6);
      ui.lon.textContent = fmt(c.longitude, 6);
      ui.alt.textContent = (c.altitude === null ? "n/a" : fmt(c.altitude, 1) + " m");
      ui.spd.textContent = (c.speed === null ? "n/a" : fmt(c.speed, 2) + " m/s");
      ui.acc.textContent = fmt(c.accuracy, 1);

      const dt = new Date(pos.timestamp);
      ui.ts.textContent = dt.toISOString();

      const d = L.latLng(MARSEILLE.lat, MARSEILLE.lon).distanceTo([c.latitude, c.longitude]);
      ui.dist.textContent = km(d);

      // maj marker + cercle
      youMarker.setLatLng([c.latitude, c.longitude]).bindPopup("Vous");
      accCircle.setLatLng([c.latitude, c.longitude]).setRadius(c.accuracy || 1);

      if (firstFix) {
        map.setView([c.latitude, c.longitude], 14, { animate: true });
        firstFix = false;
      }
    }

    function onGeoError(err) {
      console.warn("Geolocation error:", err.message);
      // affiche un popup informatif
      L.popup()
        .setLatLng(map.getCenter())
        .setContent("Geolocation non disponible: " + err.message + "<br/>Fallback centre: Nice.")
        .openOn(map);
    }

    // getCurrentPosition (one-shot)
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          updateUI(pos);
        },
        onGeoError,
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );

      // watchPosition (live updates)
      navigator.geolocation.watchPosition(
        (pos) => {
          updateUI(pos);
        },
        onGeoError,
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 1000 }
      );
    } else {
      onGeoError({ message: "API geolocation non supportee" });
    }

    // popup distance Marseille -> vous (clic sur la ligne)
    mnLine.on("click", () => {
      const p = youMarker.getLatLng();
      const d = L.latLng(MARSEILLE.lat, MARSEILLE.lon).distanceTo(p);
      mnLine.bindPopup("Distance Marseille -> vous: " + km(d) + " km").openPopup();
    });
  </script>
</body>
</html>
