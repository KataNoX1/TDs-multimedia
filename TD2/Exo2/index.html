<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>My first babylon.js app</title>
    <style>
      html, body { margin: 0; height: 100%; overflow: hidden; }
      #renderCanvas { width: 100vw; height: 100vh; display: block; }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/ammo.js"></script>
    <script src="https://cdn.babylonjs.com/ammo.wasm.js"></script>
    <script src="https://cdn.babylonjs.com/ammoJSPlugin.js"></script>
  </head>
  <body>
    <canvas id="renderCanvas"></canvas>
    <script>
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);

        async function createScene() {

            const scene = new BABYLON.Scene(engine);

            //Camera
            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 5, Math.PI / 3, 6, new BABYLON.Vector3(0, 1, 0), scene);

            camera.upperBetaLimit = Math.PI * 0.5 - 0.01;
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 10;
            camera.wheelDeltaPercentage = 0.01;

            camera.attachControl(canvas, true);
            

            //LumiÃ¨re
            const ambientLight = new BABYLON.HemisphericLight("ambientLight", new BABYLON.Vector3(0, 1, 0), scene);
            ambientLight.intensity = 0.5;

            const light = new BABYLON.DirectionalLight("light", new BABYLON.Vector3(-1, -1.5, -1), scene);
            light.position = new BABYLON.Vector3(5, 7.5, 5);
            light.intensity = 0.8;

            const shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
            shadowGenerator.useBlurExponentialShadowMap = true;


            //Physique
            await Ammo();
            await scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.AmmoJSPlugin(true));
            scene.getPhysicsEngine().setTimeStep(1/120);


            //Cube
            const cube = BABYLON.MeshBuilder.CreateBox("box", { size: 1 }, scene);
            cube.position.y = 0.5;
            shadowGenerator.addShadowCaster(cube, true);
            cube.receiveShadows = true;

            cubeMaterial = new BABYLON.StandardMaterial("cubeMat");
            cubeMaterial.diffuseTexture = new BABYLON.Texture("default.png", scene);
            cube.material = cubeMaterial;

            cube.physicsImpostor = new BABYLON.PhysicsImpostor(
                cube, BABYLON.PhysicsImpostor.BoxImpostor,
                { mass: 0, friction: 0.6, restitution: 0.1 }, scene
            );


            //Phoque
            BABYLON.SceneLoader.ImportMeshAsync("", "./", "bagel_seal.glb", scene).then((res) => {
                const root = meshes[0];
                root.position = BABYLON.Vector3(0, 2, 0);

                const sealCol = BABYLON.MeshBuilder.CreateSphere("sealCol", { diameter: 1.4 }, scene);
                sealCol.isVisible = true;
                sealCol.position = new BABYLON.Vector3(0, 2, 0);
                sealCol.physicsImpostor = new BABYLON.PhysicsImpostor(
                    sealCol, BABYLON.PhysicsImpostor.SphereImpostor,
                    { mass: 2, friction: 0.6, restitution: 0.1 }, scene
                );

                root.setParent(sealCol);

                root.getChildMeshes().forEach(m => shadowGenerator.addShadowCaster(m, true));
            });


            //Sol
            const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 10, height: 10 }, scene);
            ground.physicsImpostor = new BABYLON.PhysicsImpostor(
                ground, BABYLON.PhysicsImpostor.BoxImpostor,
                { mass: 0, restitution: 0.0, friction: 0.8 }, scene
            );

            ground.receiveShadows = true;

            return scene;
        };

        createScene().then((scene) => {
            engine.runRenderLoop(() => {
                scene.render();
            });
        });

        window.addEventListener("resize", () => engine.resize());
    </script>
  </body>
</html>